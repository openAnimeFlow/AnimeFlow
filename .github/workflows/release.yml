name: Release

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true

jobs:
  flutter-build_ios:
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
          echo "REDIRECT_URI=${{ secrets.REDIRECT_URI }}" >> .env

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      # 输出可用模拟器和 SDK
      - name: Show available simulators
        run: |
          xcrun simctl list devices
          xcodebuild -showsdks

      - name: Build iOS
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          mkdir Payload
          cp -R build/ios/iphoneos/Runner.app Payload/Runner.app
          zip -q -r "AnimeFlow-ios-${{ env.VERSION }}.ipa" Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: AnimeFlow-ios-${{ env.VERSION }}.ipa

  flutter-build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
          echo "REDIRECT_URI=${{ secrets.REDIRECT_URI }}" >> .env

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Android signing
        run: |
          # Read base64 encoded key file from secrets and decode
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/key.jks
            echo "Key store file created from base64"
          fi
          
          # create key.properties flie
          mkdir -p android
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS || 'key' }}
          storeFile=app/key.jks
          EOF
          
          # verifyFileExists
          if [ -f android/app/key.jks ]; then
            echo "✓ Key store file exists"
            ls -lh android/app/key.jks
          else
            echo "⚠ Warning: Key store file not found, build will use debug signing"
          fi

      - name: Build apk
        run: |
          flutter --version
          flutter build apk --split-per-abi --release
          echo "Android build completed"

      - name: Rename APK files
        run: |
          cd build/app/outputs/flutter-apk
          if [ -f app-armeabi-v7a-release.apk ]; then
            mv app-armeabi-v7a-release.apk "AnimeFlow-android-v7a-${{ env.VERSION }}.apk"
          fi
          if [ -f app-arm64-v8a-release.apk ]; then
            mv app-arm64-v8a-release.apk "AnimeFlow-android-arm64-${{ env.VERSION }}.apk"
          fi
          if [ -f app-x86_64-release.apk ]; then
            mv app-x86_64-release.apk "AnimeFlow-android-x86_64-${{ env.VERSION }}.apk"
          fi
          echo "Renamed APK files:"
          ls -lh AnimeFlow-android-*.apk || true

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: build/app/outputs/flutter-apk/AnimeFlow-android-*.apk
          if-no-files-found: ignore

  flutter-build-windows:
    runs-on: windows-2025
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract version
        shell: pwsh
        run: |
          $version = (Select-String -Path pubspec.yaml -Pattern '^version:' | ForEach-Object { $_.Line -replace 'version: ', '' })
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Create .env file
        shell: pwsh
        run: |
          Add-Content -Path .env -Value "CLIENT_ID=${{ secrets.CLIENT_ID }}"
          Add-Content -Path .env -Value "REDIRECT_URI=${{ secrets.REDIRECT_URI }}"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: |
          flutter build windows
          echo "Windows build completed"

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "AnimeFlow-windows-${{ env.VERSION }}.zip" -Force
          echo "Created AnimeFlow-windows-${{ env.VERSION }}.zip"

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: AnimeFlow-windows-${{ env.VERSION }}.zip
          if-no-files-found: ignore

  flutter-build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
          echo "REDIRECT_URI=${{ secrets.REDIRECT_URI }}" >> .env

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake libgtk-3-dev ninja-build libayatana-appindicator3-dev unzip webkit2gtk-4.1 libasound2-dev libsecret-1-dev libmpv-dev
          sudo apt-get install -y gcc g++ autoconf automake debhelper glslang-dev ladspa-sdk xutils-dev libasound2-dev \
              libarchive-dev libbluray-dev libbs2b-dev libcaca-dev libcdio-paranoia-dev libdrm-dev \
              libdav1d-dev libdvdnav-dev libegl1-mesa-dev libepoxy-dev libfontconfig-dev libfreetype6-dev \
              libfribidi-dev libgl1-mesa-dev libgbm-dev libgme-dev libgsm1-dev libharfbuzz-dev libjpeg-dev \
              libbrotli-dev liblcms2-dev libmodplug-dev libmp3lame-dev libopenal-dev \
              libopus-dev libopencore-amrnb-dev libopencore-amrwb-dev libpulse-dev librtmp-dev \
              libsdl2-dev libsixel-dev libssh-dev libsoxr-dev libspeex-dev libtool \
              libv4l-dev libva-dev libvdpau-dev libvorbis-dev libvo-amrwbenc-dev \
              libunwind-dev libvpx-dev libwayland-dev libx11-dev libxext-dev \
              libxkbcommon-dev libxrandr-dev libxss-dev libxv-dev libxvidcore-dev \
              linux-libc-dev nasm ninja-build pkg-config python3 python3-docutils wayland-protocols \
              x11proto-core-dev zlib1g-dev libfdk-aac-dev libtheora-dev libwebp-dev \
              unixodbc-dev libpq-dev libxxhash-dev libaom-dev
        shell: bash

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux
        run: |
          flutter build linux
          echo "Linux build completed"

      - name: Create TAR.GZ archive
        run: |
          cd build/linux/x64/release
          tar -czf ../../../../AnimeFlow-${{ env.VERSION }}.tar.gz -C bundle .
          echo "Created AnimeFlow-${{ env.VERSION }}.tar.gz"

      - name: Create DEB package
        run: |
          # 创建 Debian 包目录结构
          PACKAGE_NAME="animeflow"
          PACKAGE_DIR="animeflow_${{ env.VERSION }}_amd64"
          APP_DIR="${PACKAGE_DIR}/usr/lib/animeflow"
          mkdir -p ${PACKAGE_DIR}/DEBIAN
          mkdir -p ${APP_DIR}
          mkdir -p ${PACKAGE_DIR}/usr/bin
          mkdir -p ${PACKAGE_DIR}/usr/share/applications
          mkdir -p ${PACKAGE_DIR}/usr/share/pixmaps
          
          # 复制应用文件到 /usr/lib/animeflow
          cp -r build/linux/x64/release/bundle/* ${APP_DIR}/
          
          # 创建启动脚本
          cat > ${PACKAGE_DIR}/usr/bin/animeflow << 'EOF'
          #!/bin/bash
          cd /usr/lib/animeflow
          ./anime_flow "$@"
          EOF
          chmod +x ${PACKAGE_DIR}/usr/bin/animeflow
          
          # 创建 control 文件
          cat > ${PACKAGE_DIR}/DEBIAN/control << EOF
          Package: ${PACKAGE_NAME}
          Version: ${{ env.VERSION }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: AnimeFlow Team
          Description: Anime video player
           AnimeFlow is an anime video player application.
          EOF
          
          # 创建 desktop 文件
          cat > ${PACKAGE_DIR}/usr/share/applications/animeflow.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=AnimeFlow
          Comment=Anime video player
          Exec=/usr/bin/animeflow
          Icon=animeflow
          Terminal=false
          Categories=Video;Player;
          EOF
          
          if [ -f build/linux/x64/release/bundle/data/flutter_assets/assets/logo/Logo.png ]; then
            cp build/linux/x64/release/bundle/data/flutter_assets/assets/logo/Logo.png ${PACKAGE_DIR}/usr/share/pixmaps/animeflow.png
          fi
          
          # 构建 deb 包
          dpkg-deb --build ${PACKAGE_DIR} AnimeFlow-linux-${{ env.VERSION }}.deb
          echo "Created AnimeFlow-linux-${{ env.VERSION }}.deb"

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            AnimeFlow-linux-${{ env.VERSION }}.tar.gz
            AnimeFlow-linux-${{ env.VERSION }}.deb
          if-no-files-found: ignore

  flutter-build-macos:
    name: Build macOS
    runs-on: macos-14
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create .env file
        run: |
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
          echo "REDIRECT_URI=${{ secrets.REDIRECT_URI }}" >> .env

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS
        run: |
          flutter build macos
          echo "macOS build completed"

      - name: Create DMG
        run: |
          mkdir -p build/dist
          cp -a build/macos/Build/Products/Release/*.app build/dist
          ln -s /Applications build/dist/Applications
          hdiutil create -fs HFS+ -volname "${{ env.VERSION }}" -srcfolder build/dist build/dist/AnimeFlow-macos-${{ env.VERSION }}.dmg

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: build/dist/AnimeFlow-macos-${{ env.VERSION }}.dmg
          if-no-files-found: ignore

  release:
    needs: [flutter-build_ios, flutter-build-android, flutter-build-windows, flutter-build-linux, flutter-build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "TAG_NAME=v${VERSION}" >> $GITHUB_ENV

      - name: Generate release notes
        run: |
          # 读取 CHANGELOG.md 内容
          CHANGELOG_CONTENT=$(cat .github/workflows/CHANGELOG.md)
          
          # 读取 release-template.md 模板
          TEMPLATE=$(cat .github/workflows/release-template.md)
          
          # 在两个 --- 之间插入 CHANGELOG 内容
          RELEASE_NOTES=$(echo "$TEMPLATE" | awk -v changelog="$CHANGELOG_CONTENT" '
            /^---$/ {
              if (found_first == 0) {
                found_first = 1
                print
                print changelog
                next
              }
            }
            { print }
          ')
          
          echo "$RELEASE_NOTES" > release_notes.md
          echo "Generated release notes:"
          cat release_notes.md
        env:
          VERSION: ${{ env.VERSION }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: AnimeFlow ${{ env.VERSION }}
          body_path: release_notes.md
          files: |
            artifacts/ios/*.ipa
            artifacts/android/*.apk
            artifacts/windows/*.zip
            artifacts/linux/*.tar.gz
            artifacts/linux/*.deb
            artifacts/macos/*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}